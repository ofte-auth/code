<!DOCTYPE html>
<html>
<!-- 
    Hello curious and fellow nerd, welcome to the source code! You can find platform-relevant parts by
    searching for #ATTN, everything else is just supporting UI stuff
-->

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ofte - Basic Demo Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css">
    <script defer src="https://use.fontawesome.com/releases/v5.1.0/js/all.js"></script>

    <!-- #ATTN This is JS library for the OfteKey. You have to load this and then initialize it (see below) -->
    <script src="https://gitlab.com/ofte/code/raw/master/js/ofte.js"></script>
    
    <style>
        .hidden {
            display: none;
        }

        input {
            font-weight: 300;
        }

        p.subtitle {
            padding-top: 1rem;
        }

        .sidebar {
            font-family: 'Nexa Book', serif;
            font-weight: 700;
            background-color: #efefef;
            border-width: 1px;
            border-color: black;
            height: 2000px;
            margin: 12px;
        }
    </style>
</head>

<body>
    <div>
        <nav class="navbar is-light" role="navigation" aria-label="main navigation">
            <div class="navbar-brand">
                <a class="navbar-item" href="http://e-corp-usa.com">
                    <img src="https://static1.squarespace.com/static/571a9b3cd51cd4f1ca1c03b5/t/576d824779a5a2d4946bff6a/1466795505878/Evil_Corp_logo.png"
                        height="28">
                </a>
            </div>
            <div class="navbar-start">
                <a class="navbar-item" href="http://e-corp-usa.com">
                    Mail
                </a>
                <a class="navbar-item" href="http://e-corp-usa.com">
                    Search
                </a>
                <a class="navbar-item" href="http://e-corp-usa.com">
                    Congo Annexation Info
                </a>
                <div class="navbar-item">
                    <button class="button is-block is-info is-small" onClick="document.getElementById('confirmationModal').classList.add('is-active')">Initiate Stage 3</button>
                </div>
            </div>
            <div class="navbar-end">
                <a class="navbar-item" onclick="logout()">
                    Logout
                </a>
            </div>
        </nav>

        <div class="columns">
            <div id="sidebar" class="column is-one-fifth sidebar">
                <span class="icon is-large is-pulled-right" onclick="toggleSidebar()">
                    <i id="chevron" class="fas fa-lg fa-chevron-circle-left"></i>
                </span>
                <img src="https://ofte.io/img/ofte-logo.svg" width="80" />
                <h4 class="title is-4">Basic Demo: Dashboard</h4>
                <p class="content">
                    Because this is not a single-page webapp, the authentication process starts again when the page is
                    loaded.
                    No worries though, the Ofte platform is designed to be tolerant of interruptions like this and is
                    able to continue without issue.
                </p>
                <p class="content">
                    This page is a mock dashboard. Access to the E-Corp 'customer data' and the button that launches evil
                    <i>Stage 3</i> is
                    protected by the OfteKey. Check out the page source for details&mdash;our Promise-based data
                    wrappers make this butt-simple.
                </p>
                <p class="content">
                    If you unplug your OfteKey, your current Ofte session is killed and you're logged out.
                </p>
                <p class="content">
                    Events from various Ofte states will appear below.
                </p>
                <!-- Not found -->
                <article class="message is-small hidden" id="ofte-device-notfound">
                    <div class="message-body">
                        no OfteKey was found.
                    </div>
                </article>

                <!-- Discovered -->
                <article class="message is-small hidden" id="ofte-device-discovered">
                    <div class="message-body">
                        a plugged in OfteKey was found
                    </div>
                </article>

                <!-- Plugged In -->
                <article class="message is-small hidden" id="ofte-device-plugged">
                    <div class="message-body">
                        an OfteKey was plugged in
                    </div>
                </article>

                <!-- Paired -->
                <article class="message is-small hidden" id="ofte-device-paired">
                    <div class="message-body">
                        a plugged in OfteKey was paired
                    </div>
                </article>

                <!-- Opened -->
                <article class="message is-small hidden" id="ofte-device-opened">
                    <div class="message-body">
                        a plugged in OfteKey was opened
                    </div>
                </article>

                <!-- Device Inited -->
                <article class="message is-small hidden" id="ofte-device-inited">
                    <div class="message-body">
                        a plugged in OfteKey initialized an encrypted message
                    </div>
                </article>

                <!-- Service Inited -->
                <article class="message is-small hidden" id="ofte-service-inited">
                    <div class="message-body">
                        the OfteKey successfully initialized to the service
                    </div>
                </article>

                <!-- Device Processed -->
                <article class="message is-small hidden" id="ofte-device-processed">
                    <div class="message-body">
                        a plugged in OfteKey processed an encrypted message
                    </div>
                </article>

                <!-- Service Processed -->
                <article class="message is-small hidden" id="ofte-service-processed">
                    <div class="message-body">
                        the Ofte service processed an encrypted message. this is an indication
                        of an Ofte-authenticated state.
                        <br>
                        <div class="control">
                            <div class="tags has-addons">
                                <span class="tag is-dark">message count</span>
                                <span id="countTag" class="tag is-info">1</span>
                            </div>
                        </div>
                    </div>
                </article>

                <!-- Device Erred -->
                <article class="message is-danger hidden" id="ofte-device-erred">
                    <div class="message-body">
                        the Ofte device encountered an error
                    </div>
                    <div id="deviceErrorMsg" class="message-body">

                    </div>
                </article>

                <!-- Service Erred -->
                <article class="message is-danger hidden" id="ofte-service-erred">
                    <div class="message-body">
                        an error occurred in the Ofte service
                    </div>
                    <div id="serviceErrorMsg" class="message-body">

                    </div>
                </article>

                <!-- Network Erred -->
                <article class="message is-danger hidden" id="ofte-network-erred">
                    <div class="message-body">
                        a network error occurred
                    </div>
                    <div id="networkErrorMsg" class="message-body">

                    </div>
                </article>

            </div>

            <div class="column">
                <div class="container">
                    <span id="sliderbutton" class="icon is-large is-pulled-left is-hidden" onclick="toggleSidebar()">
                        <i id="chevron" class="fas fa-lg fa-chevron-circle-right"></i>
                    </span>

                    <div class="level">
                        <div class="level-left">
                            <div class="level-item">
                                <div class="title"><br>E-Corp Company Dashboard</div>
                            </div>
                        </div>
                    </div>


                    <div class="container">
                        <div class="level">
                            <div class="level-left">
                                <div class="level-item">
                                    <div class="subtitle">Customer data</div>
                                </div>
                            </div>
                        </div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Firstname</th>
                                    <th>Lastname</th>
                                    <th>Email</th>
                                    <th>Gender</th>
                                    <th>IP Address</th>
                                    <th>Credit Card</th>
                                    <th>SSN</th>
                                </tr>
                            </thead>
                            <tbody id='customerTable' style="font-weight: 300">
                            </tbody>
                        </table>
                    </div>
                    <br><br>
                    <button class="button is-success" onclick="loadCustomerData()">Load More Customers</button>
                    <div class="level is-small">Note: this request is protected by the OfteKey</div>
                </div>
            </div>
        </div>
        <div id="confirmationModal" class="modal">
            <div class="modal-background"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">Initiate Stage 3?</p>
                </header>
                <section class="modal-card-body">
                    Are you sure you want to initiate Stage 3?
                </section>
                <footer class="modal-card-foot">
                    <button class="button is-success" onclick="launchStage3()">Initiate Stage 3</button>
                    <button class="button" onclick="document.getElementById('confirmationModal').classList.remove('is-active')">Cancel</button>
                </footer>
            </div>
        </div>
    </div>
    <script>
        function logout() {
            // #ATTN It's good practice to call endSession here, it clears the authenticated session and resets the OfteKey
            ofte.endSession();
            window.location = "index.html";
        }

        function launchStage3() {
            // #ATTN Here's the request to initiate Stage 3 is protected by the OfteKey
            ofte.getJSONResponseAuthorized('POST', '/v1/stage3', null)
                .then(() => {
                    window.location = 'http://geektyper.com/fsociety/';
                })
                .catch((err) => {
                    console.log('Error initiating stage 3: ', err);
                })
        }

        // The rest of this script section are functions to support the demo. "Move along, nothing to see here"...
        // -------------
        function toggleSidebar() {
            var element = document.getElementById('sidebar');
            if (element.classList.contains('column')) {
                element.classList.replace('column', 'is-hidden');
                document.getElementById('chevron').classList.replace('fa-chevron-circle-left', 'fa-chevron-circle-right');
                document.getElementById('sliderbutton').classList.remove('is-hidden');
            } else {
                element.classList.replace('is-hidden', 'column');
                document.getElementById('chevron').classList.replace('fa-chevron-circle-right', 'fa-chevron-circle-left');
                document.getElementById('sliderbutton').classList.add('is-hidden');
            }
        }
        function reveal(id) {
            var element = document.getElementById(id);
            element.classList.remove("hidden");
        }
        function hide(id) {
            var element = document.getElementById(id);
            element.classList.add("hidden");
        }

        ofte.on(ofte.eventDeviceNotFound, function (event) { reveal(event.type) });
        ofte.on(ofte.eventDeviceDiscovered, function (event) { reveal(event.type) });
        ofte.on(ofte.eventDevicePlugged, function (event) {
            reveal(event.type)
            hide(ofte.eventDeviceNotFound)
        });
        ofte.on(ofte.eventDeviceUnplugged, function (event) {
            hide(ofte.eventDevicePlugged)
            reveal(ofte.eventDeviceNotFound)
            logout()
        });
        ofte.on(ofte.eventDevicePaired, function (event) { reveal(event.type) });
        ofte.on(ofte.eventDeviceOpened, function (event) { reveal(event.type) });
        ofte.on(ofte.eventDeviceInited, function (event) { reveal(event.type) });
        ofte.on(ofte.eventDeviceProcessed, function (event) { reveal(event.type) });
        ofte.on(ofte.eventSvcInited, function (event) { reveal(event.type) });
        var count = 0;
        ofte.on(ofte.eventSvcProcessed, function (event) {
            reveal(event.type);
            ++count;
            element = document.getElementById('countTag');
            element.textContent = Number(count).toLocaleString();
            if (count == 1) {
                loadCustomerData()
            }
        });
        ofte.on(ofte.eventDeviceErred, function (event) {
            reveal(event.type);
            document.getElementById('deviceErrorMsg').textContent = event.detail;
        });
        ofte.on(ofte.eventSvcErred, function (event) {
            reveal(event.type);
            let msg = typeof (event.detail) === 'string' ? event.detail : event.detail.type;
            document.getElementById('serviceErrorMsg').textContent = msg;
            if (event.code == ofte.eventSvcErred) {
                ofte.startSession();
            }
        });
        ofte.on(ofte.eventNetworkErred, function (event) {
            reveal(event.type);
            let msg = typeof (event.detail) === 'string' ? event.detail : event.detail.type;
            document.getElementById('networkErrorMsg').textContent = msg;
        });

        async function loadCustomerData() {
            await ofte.getJSONResponseAuthorized("GET", "/v1/customers", null)
                .then((response) => {
                    let txt = '';
                    data = JSON.parse(response.responseText);
                    for (x in data) {
                        txt += "<tr>";
                        txt += "<td>" + data[x].id + "</td>";
                        txt += "<td>" + data[x].first_name + "</td>";
                        txt += "<td>" + data[x].last_name + "</td>";
                        txt += "<td>" + data[x].email + "</td>";
                        txt += "<td>" + data[x].gender + "</td>";
                        txt += "<td>" + data[x].ip_address + "</td>";
                        txt += "<td>" + data[x].credit_card + "</td>";
                        txt += "<td>" + data[x].ssn + "</td>";
                        txt += "</tr>";
                    }
                    document.getElementById("customerTable").innerHTML = txt;

                })
                .catch((err) => {
                    console.log('error:', err)
                })
        }


    </script>
</body>

</html>